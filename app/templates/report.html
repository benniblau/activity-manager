{% extends "base.html" %}
{% from "macros.html" import sport_icon, pain_icon %}

{% block title %}Activity Report - Activity Manager{% endblock %}

{% block content %}
<!-- Back Navigation -->
<div class="mb-4">
    <a href="/" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Activities
    </a>
</div>

<!-- Report Header -->
<div class="card stats-card mb-4">
    <div class="card-header">
        <i class="bi bi-calendar-range"></i> Activity Report
    </div>
    <div class="card-body">
        <!-- Date Range Selector -->
        <form method="get" class="row g-3 align-items-end mb-4">
            <div class="col-md-3">
                <label class="form-label small text-muted">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Generate Report
                </button>
                <a href="/report/csv?start_date={{ start_date }}&end_date={{ end_date }}" class="btn btn-outline-success ms-2">
                    <i class="bi bi-download"></i> Export CSV
                </a>
            </div>
            <div class="col-md-3">
                <!-- Quick date presets -->
                <div class="btn-group btn-group-sm">
                    <a href="?start_date={{ (end_date | replace('-', '') | int - 7) // 10000 }}-{{ '%02d' | format(((end_date | replace('-', '') | int - 7) % 10000) // 100) }}-{{ '%02d' | format((end_date | replace('-', '') | int - 7) % 100) }}&end_date={{ end_date }}" class="btn btn-outline-secondary">7 Days</a>
                    <a href="?start_date={{ (end_date | replace('-', '') | int - 30) // 10000 }}-{{ '%02d' | format(((end_date | replace('-', '') | int - 30) % 10000) // 100) }}-{{ '%02d' | format((end_date | replace('-', '') | int - 30) % 100) }}&end_date={{ end_date }}" class="btn btn-outline-secondary">30 Days</a>
                    <a href="?start_date={{ (end_date | replace('-', '') | int - 90) // 10000 }}-{{ '%02d' | format(((end_date | replace('-', '') | int - 90) % 10000) // 100) }}-{{ '%02d' | format((end_date | replace('-', '') | int - 90) % 100) }}&end_date={{ end_date }}" class="btn btn-outline-secondary">90 Days</a>
                </div>
            </div>
        </form>

        <!-- Summary Stats -->
        <div class="row text-center mb-3">
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    <h4 class="mb-0">{{ total_activities }}</h4>
                    <small class="text-muted">Actual Activities</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    <h4 class="mb-0">{{ total_planned }}</h4>
                    <small class="text-muted">Planned Activities</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    {% if overall_completion_rate is not none %}
                    <h4 class="mb-0 {% if overall_completion_rate >= 80 %}text-success{% elif overall_completion_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.0f"|format(overall_completion_rate) }}%
                    </h4>
                    {% else %}
                    <h4 class="mb-0 text-muted">-</h4>
                    {% endif %}
                    <small class="text-muted">Completion Rate</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    <h4 class="mb-0">{{ "%.1f"|format(total_distance / 1000) }} km</h4>
                    <small class="text-muted">Total Distance</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    <h4 class="mb-0">{{ (total_time // 3600)|int }}h {{ ((total_time % 3600) // 60)|int }}m</h4>
                    <small class="text-muted">Total Time</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-3 border rounded">
                    <h4 class="mb-0">{{ days_with_activities }} / {{ total_days }}</h4>
                    <small class="text-muted">Active Days</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Table -->
<div class="card stats-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 report-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">Date</th>
                        <th style="width: 100px;">Day</th>
                        <th style="width: 90px;" class="text-center">Completion</th>
                        <th style="width: 80px;" class="text-center">Day Feel</th>
                        <th style="width: 150px;">Day Notes</th>
                        <th style="width: 200px;">Planned Activities</th>
                        <th>Actual Activities</th>
                        <th style="width: 100px;" class="text-end">Distance</th>
                        <th style="width: 100px;" class="text-end">Duration</th>
                        <th style="width: 80px;" class="text-center">Before</th>
                        <th style="width: 80px;" class="text-center">During</th>
                        <th style="width: 80px;" class="text-center">After</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in all_days %}
                    {% set day_feel = day_feelings.get(day.date, {}) %}
                    {% if day.activities %}
                    {% for activity in day.activities %}
                    <tr class="{% if loop.first %}day-first-row{% endif %}">
                        {% if loop.first %}
                        <td rowspan="{{ day.activities|length }}" class="align-middle fw-bold day-cell">
                            {{ day.date }}
                        </td>
                        <td rowspan="{{ day.activities|length }}" class="align-middle day-cell">
                            {{ day.weekday[:3] }}
                        </td>
                        <td rowspan="{{ day.activities|length }}" class="align-middle text-center day-cell">
                            {% if day.completion_rate is not none %}
                            <span class="badge {% if day.completion_rate >= 80 %}bg-success{% elif day.completion_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ "%.0f"|format(day.completion_rate) }}%
                            </span>
                            <div class="small text-muted">{{ day.num_actual }}/{{ day.num_planned }}</div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td rowspan="{{ day.activities|length }}" class="align-middle text-center day-cell">
                            {{ pain_icon(day_feel.feeling_pain if day_feel else none) }}
                        </td>
                        <td rowspan="{{ day.activities|length }}" class="align-middle day-cell">
                            {% if day_feel.feeling_text %}
                            <span class="small" title="{{ day_feel.feeling_text }}">{{ day_feel.feeling_text }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td rowspan="{{ day.activities|length }}" class="align-middle small day-cell">
                            {% if day.planned_activities %}
                            {% for planned in day.planned_activities %}
                            <div class="mb-1">
                                <span class="badge {{ planned.extended_color or 'bg-secondary' }} me-1">
                                    {% if planned.extended_icon %}
                                    <i class="{{ planned.extended_icon }}"></i>
                                    {% endif %}
                                    {{ planned.extended_name or planned.sport_type }}
                                </span>
                                {{ planned.name }}
                                {% if planned.matched_activity_id %}
                                <i class="bi bi-check-circle text-success" title="Matched"></i>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">No plan</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            <a href="/activity/{{ activity.id }}" class="text-decoration-none">
                                <span class="badge badge-sport-{{ activity.sport_type|lower|replace(' ', '')|replace('-', '') }} me-1">{{ sport_icon(activity.sport_type) }} {{ activity.sport_type }}</span>
                                {{ activity.name }}
                            </a>
                        </td>
                        <td class="text-end">
                            {% if activity.distance %}
                            {{ "%.2f"|format(activity.distance / 1000) }} km
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if activity.moving_time %}
                            {{ (activity.moving_time // 3600)|int }}:{{ '%02d'|format((activity.moving_time % 3600) // 60) }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {{ pain_icon(activity.feeling_before_pain) }}
                        </td>
                        <td class="text-center">
                            {{ pain_icon(activity.feeling_during_pain) }}
                        </td>
                        <td class="text-center">
                            {{ pain_icon(activity.feeling_after_pain) }}
                        </td>
                        <td class="small">
                            {% if activity.feeling_before_text or activity.feeling_during_text or activity.feeling_after_text %}
                            <div class="notes-cell">
                                {% if activity.feeling_before_text %}
                                <div class="text-truncate" title="{{ activity.feeling_before_text }}">
                                    <strong>B:</strong> {{ activity.feeling_before_text }}
                                </div>
                                {% endif %}
                                {% if activity.feeling_during_text %}
                                <div class="text-truncate" title="{{ activity.feeling_during_text }}">
                                    <strong>D:</strong> {{ activity.feeling_during_text }}
                                </div>
                                {% endif %}
                                {% if activity.feeling_after_text %}
                                <div class="text-truncate" title="{{ activity.feeling_after_text }}">
                                    <strong>A:</strong> {{ activity.feeling_after_text }}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="rest-day">
                        <td class="fw-bold">{{ day.date }}</td>
                        <td>{{ day.weekday[:3] }}</td>
                        <td class="text-center">
                            {% if day.completion_rate is not none %}
                            <span class="badge {% if day.completion_rate >= 80 %}bg-success{% elif day.completion_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ "%.0f"|format(day.completion_rate) }}%
                            </span>
                            <div class="small text-muted">{{ day.num_actual }}/{{ day.num_planned }}</div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {{ pain_icon(day_feel.feeling_pain if day_feel else none) }}
                        </td>
                        <td>
                            {% if day_feel.feeling_text %}
                            <span class="small" title="{{ day_feel.feeling_text }}">{{ day_feel.feeling_text }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="small">
                            {% if day.planned_activities %}
                            {% for planned in day.planned_activities %}
                            <div class="mb-1">
                                <span class="badge {{ planned.extended_color or 'bg-secondary' }} me-1">
                                    {% if planned.extended_icon %}
                                    <i class="{{ planned.extended_icon }}"></i>
                                    {% endif %}
                                    {{ planned.extended_name or planned.sport_type }}
                                </span>
                                {{ planned.name }}
                            </div>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">No plan</span>
                            {% endif %}
                        </td>
                        <td colspan="7" class="text-muted fst-italic">Rest day - No activities</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}
